---
// src/components/VitalsDashboard.astro
import { promises as fs } from 'fs';
import path from 'path';

// Import the helper components
import KpiCard from './KpiCard.astro';
import DashboardSection from './DashboardSection.astro'; 

interface Kpi { organic_traffic: string; organic_impressions: string; avg_ctr: string; }
interface TechHealth { cwv_good_percent: number; index_valid: number; index_errors: number; }
interface Content { top_gaining_keywords: { keyword: string, position: number, change: string }[]; top_landing_pages: { url: string, traffic: string }[]; }
interface VitalsData { last_updated: string; performance_kpis: Kpi; technical_health: TechHealth; content_strategy: Content; }

let data: VitalsData | null = null;
let lastUpdated = "Never";
try {
  const jsonPath = path.resolve(process.cwd(), 'src/data/seo-vitals.json');
  const jsonData = await fs.readFile(jsonPath, 'utf-8'); // Corrected from fs.read to fs.readFile
  data = JSON.parse(jsonData) as VitalsData;
  lastUpdated = new Date(data.last_updated).toLocaleString('en-US', { 
    dateStyle: 'medium', 
    timeStyle: 'short' 
  });
} catch (e) {
  console.error("Failed to load seo-vitals.json:", e.message);
}
---

{data ? (
  <div class="space-y-8">
    <p class="text-center text-sm text-gray-400">Last Updated: {lastUpdated}</p>

    <DashboardSection title="Performance KPIs (The Results)">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <KpiCard title="Organic Traffic (30d)" value={data.performance_kpis.organic_traffic} />
        <KpiCard title="Organic Impressions (30d)" value={data.performance_kpis.organic_impressions} />
        <KpiCard title="Average CTR (30d)" value={data.performance_kpis.avg_ctr} />
      </div>
    </DashboardSection>

    <DashboardSection title="Technical Health (The Foundation)">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <KpiCard title="Core Web Vitals 'Good' %" value={`${data.technical_health.cwv_good_percent}%`} />
        <KpiCard title="Valid Indexed Pages" value={data.technical_health.index_valid} />
        <KpiCard title="Indexation Errors" value={data.technical_health.index_errors} />
      </div>
    </DashboardSection>

    <DashboardSection title="On-Page & Content (The Work)">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700">
          <h4 class="text-lg font-semibold text-white mb-4">Top Gaining Keywords</h4>
          <ul class="space-y-2">
            {data.content_strategy.top_gaining_keywords.map(item => (
              <li class="flex justify-between text-sm text-gray-300">
                <span>{item.keyword}</span>
                <span class="font-mono text-gray-100">Pos: {item.position}</span>
              </li>
            ))}
          </ul>
        </div>
        <div class="bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700">
          <h4 class="text-lg font-semibold text-white mb-4">Top Organic Landing Pages</h4>
          <ul class="space-y-2">
            {data.content_strategy.top_landing_pages.map(item => (
              <li class="flex justify-between text-sm text-gray-300">
                <span class="truncate pr-4" title={item.url}>{item.url}</span>
                <span class="font-mono text-gray-100">{item.traffic} sessions</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </DashboardSection>

  </div>
) : (
  <div class="text-center text-yellow-400 bg-yellow-900/20 p-6 rounded-lg border border-yellow-700">
    <h2 class="text-xl font-bold mb-2">Data Not Found</h2>
    <p>The 'seo-vitals.json' file could not be loaded. Please run the build script locally or check the Netlify build logs for errors.</p>
  </div>
)}
<style>
  /* Simple placeholder for a donut chart */
  .donut-chart {
    display: grid;
    place-items: center;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: conic-gradient(
      #22c55e var(--percent, 0%), 
      #374151 0
    );
  }
</style>